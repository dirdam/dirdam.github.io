<!-- Copyright (c) Adrián Jiménez Pascual -  All rights reserved -->
<!-- This page and its content is protected under copyright and intellectual property laws.  -->
<!-- The content belongs to Adrián Jiménez Pascual, Tokio, Japan -->
<!-- All rights reserved. -->
<!--
  **  Lawbreakers will be reported to competent authorities and sentenced by the law   **
-->
<!--Copyright (c) Adrián Jiménez Pascual - http://www.ms.u-tokyo.ac.jp/~adri/ -->

<form id="function_form">Function: f(x)=</form>
<input type="text" id="function_text" value="x*x">
<form id="width_form">Values per x-branch: </form>
<input type="number" id="values_width" value="10" min="1">
<button id="runButton">Draw</button>
<form id="check_form">Extensio </form>
<input type="checkbox" id="frame_check">
<form id="focus_form1">Focus on: </form>
<form id="focus_form2">x=</form>
<form id="focus_form3">y=</form>
<input type="number" id="focus_x" value="0">
<input type="number" id="focus_y" value="0">
<form id="steps_form">Points to plot: </form>
<input type="number" id="number_steps" value="1000" min="0" step="1000">
<link rel="shortcut icon" href="../Lasso_logo.ico"/>

<title>Bounded functions</title>

<script>
var min;
var side; //Side length of the bounded canvas
onload = function() {
	//Canvas
    canvas = document.createElement("canvas");
    document.body.appendChild(canvas);
    canvas.style.position = "absolute";
    canvas.style.left = 0;
    canvas.style.top = 0;
    canvas.width = innerWidth;
    canvas.height = innerHeight*4/5;
    context = canvas.getContext("2d");

    min = Math.min(canvas.width, canvas.height);
    side = min/2; //Side of the function area

    locateHTML();

    clearCanvas(0, 0);
    run(0, 0);
}

function locateHTML() { //Sets HTML environment
	position(function_form, canvas.width/8, innerHeight*(1-3/20)); //Function text
	function_form.appendChild(function_text); //Function input
	position(width_form, canvas.width/8, innerHeight*(1-1.7/20)); //Function text
	width_form.appendChild(values_width); //Function input
	var focus_left = canvas.width*5/8;
	position(focus_form1, focus_left, innerHeight*(1-3/20)); //Focus text
	position(focus_form2, focus_left + context.measureText("Focus on: XXXXX").width, innerHeight*(1-3/20)); //Focus x
	focus_form2.appendChild(focus_x); //Value x
	focus_form2.appendChild(focus_form3); //Focus y
	focus_form3.appendChild(focus_y); //Value y
	position(runButton, innerWidth/2 - context.measureText("Draw").width, innerHeight*(1-3/20)); //Run button
	position(check_form, innerWidth/2 - context.measureText("Extensio").width, innerHeight*(1-1.7/20)); //Frame checkbox
	check_form.appendChild(frame_check);
	position(steps_form, focus_left, innerHeight*(1-1.7/20)); //Steps
	steps_form.appendChild(number_steps);

	runButton.onclick = function() {
		run(parseInt(focus_x.value*1000)/1000, parseInt(focus_y.value*1000)/1000); //Run acording to focus
	}
	frame_check.onchange = function() {
		run(parseInt(focus_x.value*1000)/1000, parseInt(focus_y.value*1000)/1000); //Run acording to focus
	}
}

function position(name, left, top) {
    name.style.position = "absolute";
    name.style.left = left;
    name.style.top = top;	
}

function clearCanvas(center_x, center_y) { //Clears all and draws axis
	context.fillStyle = "rgb(240,240,240)";
	context.fillRect(0, 0, canvas.width, canvas.height);

	context.font = "15px Verdana";
	context.fillStyle = "rgb(127,127,127)";
	context.fillText("\u00A9Adr\u00ef"/*"\xA9 WiDo"/*Adr\u00ef"/*+"i\xE1n Jim\xE9nez Pascual"*/, canvas.width - context.measureText("ORWiDo ").width, canvas.height - 15);

	drawAxis(center_x, center_y);
}

function drawAxis(center_x, center_y) { //Draws both axis in the canvas
	//Division line
	context.beginPath();
	context.lineWidth = 5;
	context.strokeStyle = "black";
	context.moveTo(canvas.width/2, 0);
	context.lineTo(canvas.width/2, canvas.height);
	context.stroke();

	//First canvas (real canvas)
	context.beginPath(); //Dark axis
	context.lineWidth = 2;
	context.moveTo(0, canvas.height/2 + center_y*canvas.height/(2*axis_height));
	context.lineTo(canvas.width/2, canvas.height/2 + center_y*canvas.height/(2*axis_height));
	if (canvas.width/4 - center_x*canvas.width/(4*axis_width) < canvas.width/2) {
		context.moveTo(canvas.width/4 - center_x*canvas.width/(4*axis_width), 0);
		context.lineTo(canvas.width/4 - center_x*canvas.width/(4*axis_width), canvas.height);
	}
	context.stroke();
	context.globalAlpha = 0.1; //Distance 1 axis
	context.moveTo((canvas.width/4)*(1 - 1/axis_width), 0);
	context.lineTo((canvas.width/4)*(1 - 1/axis_width), canvas.height);
	context.moveTo((canvas.width/4)*(1 + 1/axis_width), 0);
	context.lineTo((canvas.width/4)*(1 + 1/axis_width), canvas.height);
	context.moveTo(0, (canvas.height/2)*(1 - 1/axis_height));
	context.lineTo(canvas.width/2, (canvas.height/2)*(1 - 1/axis_height));
	context.moveTo(0, (canvas.height/2)*(1 + 1/axis_height));
	context.lineTo(canvas.width/2, (canvas.height/2)*(1 + 1/axis_height));
	context.stroke();
	context.globalAlpha = 1;

	context.beginPath(); //Centered axis
	context.globalAlpha = 0.25;
	context.moveTo(0, canvas.height/2);
	context.lineTo(canvas.width/2, canvas.height/2);
	context.moveTo(canvas.width/4, 0);
	context.lineTo(canvas.width/4, canvas.height);
	context.stroke();
	context.globalAlpha = 1;

	context.fillStyle = "blue";
	context.beginPath();
	context.arc(canvas.width/4, canvas.height/2, 3, 0, Math.PI*2);
	context.fill();

	if (frame_check.checked && (canvas.width/4 - center_x*canvas.width/(4*axis_width) - (canvas.width/4)/axis_width < canvas.width/2)) {
		context.beginPath(); //Distance 1 axis
		context.strokeStyle = "rgb(63,0,0)";
		context.strokeRect(canvas.width/4 - center_x*canvas.width/(4*axis_width) - (canvas.width/4)/axis_width, canvas.height/2 + center_y*canvas.height/(2*axis_height) - (canvas.height/2)/axis_height, (canvas.width/4)*2/axis_width, (canvas.height/2)*2/axis_height);
		context.globalAlpha = 1;
		context.strokeStyle = "black";
	}

	//Second canvas (reduced canvas)
	context.beginPath(); //Bound
	context.lineWidth = 4;
	context.strokeRect(canvas.width*3/4 - side/2, canvas.height/2 - side/2, side, side);
	context.lineWidth = 2; //Distance 1
	context.globalAlpha = 0.1;
	context.moveTo(canvas.width*3/4 - side/4, canvas.height/2 - side/2);
	context.lineTo(canvas.width*3/4 - side/4, canvas.height/2 + side/2);
	context.moveTo(canvas.width*3/4 + side/4, canvas.height/2 - side/2);
	context.lineTo(canvas.width*3/4 + side/4, canvas.height/2 + side/2);
	context.moveTo(canvas.width*3/4 - side/2, canvas.height/2 - side/4);
	context.lineTo(canvas.width*3/4 + side/2, canvas.height/2 - side/4);
	context.moveTo(canvas.width*3/4 - side/2, canvas.height/2 + side/4);
	context.lineTo(canvas.width*3/4 + side/2, canvas.height/2 + side/4);
	context.stroke();
	context.globalAlpha = 1;
	context.beginPath(); //Dark axis
	context.lineWidth = 2;
	context.moveTo(canvas.width*3/4 - side/2, canvas.height/2 + trans2(center_y)*side/2);
	context.lineTo(canvas.width*3/4 + side/2, canvas.height/2 + trans2(center_y)*side/2);
	context.moveTo(canvas.width*3/4 - trans2(center_x)*side/2, canvas.height/2 - side/2);
	context.lineTo(canvas.width*3/4 - trans2(center_x)*side/2, canvas.height/2 + side/2);
	context.stroke();

	context.beginPath(); //Centered axis
	context.lineWidth = 2;
	context.globalAlpha = 0.25;
	context.moveTo(canvas.width*3/4 - side/2, canvas.height/2);
	context.lineTo(canvas.width*3/4 + side/2, canvas.height/2);
	context.moveTo(canvas.width*3/4, canvas.height/2 - side/2);
	context.lineTo(canvas.width*3/4, canvas.height/2 + side/2);
	context.stroke();
	context.globalAlpha = 1;
	
	context.fillStyle = "blue";
	context.beginPath();
	context.arc(canvas.width*3/4, canvas.height/2, 3, 0, Math.PI*2);
	context.fill();

	if (frame_check.checked) {
		context.beginPath(); //Distance 1 axis
		context.strokeStyle = "rgb(63,0,0)";
		context.strokeRect(canvas.width/4 - center_x*canvas.width/(4*axis_width) - (canvas.width/4)/axis_width, canvas.height/2 + center_y*canvas.height/(2*axis_height) - (canvas.height/2)/axis_height, (canvas.width/4)*2/axis_width, (canvas.height/2)*2/axis_height);
		context.globalAlpha = 1;
		context.strokeStyle = "black";
	}
}

var axis_width, axis_height;
function run(center_x, center_y) { //Calculate and plot
	var steps = parseInt(number_steps.value); //Number of steps to calculate
	axis_width = parseInt(values_width.value); //Values that fit in the real x-axis
	axis_height = axis_width*canvas.height/(canvas.width/2); //Values for real y-axis
	clearCanvas(center_x, center_y);
	//Real
	for (var i = 0; i < steps; i++) {
		var x = axis_width*(- 1 + 2*i/steps) + center_x;
		var y = (!frame_check.checked ? funct(x) : trans2(funct(trans1(x) + center_x) - center_y));
		plot(canvas.width/4 + ((x - center_x)/axis_width)*canvas.width/4, canvas.height/2 - ((y - center_y)/axis_height)*canvas.height/2);
	}
	//Bounded
	for (var i = 1; i < steps; i++) {
		var x = - 1 + 2*i/steps;
		var y = (!frame_check.checked ? trans2(funct(trans1(x) + center_x) - center_y) : trans2(funct2(trans1(x) + center_x, center_x, center_y) - center_y));
		plot(canvas.width*3/4 + x*side/2, canvas.height/2 - y*side/2);
	}
}

function trans1(x) { //Transforms a number from [-1,1] to (-inf,inf)
	return x/(1 - Math.abs(x));
}

function funct(x) { //Function to be applied
	//This function has to interpret the text in the "function_text"
	return eval(function_text.value);
}

function trans2(x) { //Transforms a number from (-inf,inf) to [-1,1]
	return x/(1 + Math.abs(x));
}

function funct2(x, a, b) {
	return trans2(funct(trans1(x) + a) - b);
}

var plot_color = "red";
var plot_radius = 0.5;
function plot(x, y) { //Plots a point
	context.fillStyle = plot_color;
	context.beginPath();
	context.arc(x, y, plot_radius, 0, Math.PI*2);
	context.fill();
}

//Drag
var mouse_move_activated = false;
var first_x, first_y;
var final_x, final_y;
var original_steps_value; //During move the number of steps is reduced for calculi
ontouchstart = function(event) {
	first_x = event.touches[0].clientX;
	first_y = event.touches[0].clientY;
	if (first_y < canvas.height && first_x < canvas.width/2) {
		mouse_move_activated = true;
		original_steps_value = number_steps.value;
		number_steps.value = 1000;	
	}
}
ontouchmove = function(event) {
	//event.preventDefault(); //Not sure about this
	var x = event.touches[0].clientX;
	var y = event.touches[0].clientY;
	if (mouse_move_activated && y < canvas.height && x < canvas.width/2) {
		commonStart(x, y);
	}
}
ontouchend = function(event) {
	var x = event.touches[0].clientX;
	var y = event.touches[0].clientY;
	if (y < canvas.height && x < canvas.width/2) {
		focus_x.value = parseInt(final_x*1000)/1000;
		focus_y.value = parseInt(final_y*1000)/1000;
		number_steps.value = original_steps_value;
		run(parseInt(focus_x.value*1000)/1000, parseInt(focus_y.value*1000)/1000);
		mouse_move_activated = false;
	}
}
onmousedown = function(event) {
	first_x = event.clientX;
	first_y = event.clientY;
	if (first_y < canvas.height && first_x < canvas.width/2) {
		mouse_move_activated = true;
		original_steps_value = number_steps.value;
		number_steps.value = 1000;	
	}
}
onmousemove = function(event) {
	var x = event.clientX;
	var y = event.clientY;
	if (mouse_move_activated && y < canvas.height && x < canvas.width/2) {
		commonStart(x, y);
	}
}
onmouseup = function(event) {
	var x = event.clientX;
	var y = event.clientY;
	if (y < canvas.height && x < canvas.width/2) {
		focus_x.value = parseInt(final_x*1000)/1000;
		focus_y.value = parseInt(final_y*1000)/1000;
		number_steps.value = original_steps_value;
		run(parseInt(focus_x.value*1000)/1000, parseInt(focus_y.value*1000)/1000);
		mouse_move_activated = false;
	}
}
function commonStart(x, y) {
	var difference_x = x - first_x;
	var difference_y = first_y - y;
	final_x = Math.floor((focus_x.value - difference_x/((canvas.width/4)/axis_width))*1000)/1000;
	final_y = Math.floor((focus_y.value - difference_y/((canvas.height/2)/axis_height))*1000)/1000;
	run(parseInt(final_x*1000)/1000, parseInt(final_y*1000)/1000);
}

onkeydown = function(event){
	if (event.keyCode == 13) {
		run(parseInt(focus_x.value*1000)/1000, parseInt(focus_y.value*1000)/1000);
	}
}
</script>