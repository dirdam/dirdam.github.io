<!-- Copyright (c) Adrián Jiménez Pascual -  All rights reserved -->
<!-- This page and its content is protected under copyright and intellectual property laws.  -->
<!-- The content belongs to Adrián Jiménez Pascual, Tokio, Japan -->
<!-- All rights reserved. -->
<!--
  **  Lawbreakers will be reported to competent authorities and sentenced by the law   **
-->
<!--Copyright (c) Adrián Jiménez Pascual - http://www.ms.u-tokyo.ac.jp/~adri/ -->

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="shortcut icon" href="../Lasso_logo.ico"/>

<title>Revert!</title>

<script>

var size = 3;
var tile_radius;
var colors = ["skyblue", "royalblue", "turquoise"];

var Tile = function(x, y, color) {
	this.x = x;
	this.y = y;
	this.color = color;
}

Tile.prototype.revert = function() {
	this.color = (this.color+1)%2;
}

Tile.prototype.draw = function() {
	drawSquare(this.x, this.y, colors[this.color]);
}


function drawSquare(x, y, color) {
	context.fillStyle = color;
	context.fillRect(x*tile_radius + x_space, y*tile_radius + y_space, tile_radius, tile_radius);
	context.strokeRect(x*tile_radius + x_space, y*tile_radius + y_space, tile_radius, tile_radius);
}

var board;
var x_space, y_space;
var background_color;
onload = function() {
    canvas = document.createElement("canvas");
    document.body.appendChild(canvas);
    canvas.style.position = "absolute";
    canvas.style.left = 0;
    canvas.style.top = 0;
    canvas.width = innerWidth;
    canvas.height = innerHeight;
    context = canvas.getContext("2d");

   	startGame();
}

function startGame() {
	background_color = "lightcyan";	

    context.lineWidth = 5;

    tile_radius = (Math.min(canvas.width, canvas.height)*25/30)/size;
    x_space = (canvas.width - tile_radius*size)/2;
    y_space = (canvas.height - tile_radius*size)/2;

	drawBackground(background_color);

    board = new Array(size); //Initialize the board
    for (var i = 0; i < board.length; i++) {
    	board[i] = new Array(size);
    	for (var j = 0; j < board[i].length; j++) {
    		board[i][j] = new Tile(i, j, 0);
			board[i][j].draw();
    	}
    }

    randomize();
}

function randomize() {
	for (var i = 0; i < board.length; i++) {
		for (var j = 0; j < board.length; j++) {
			var rand = Math.random();
			if (rand < 0.5) {
				touchedX = i*tile_radius;
				touchedY = j*tile_radius;
				sharedStart();
			}
		}
	}
}

function drawBackground(color) {
	context.fillStyle = color; //Fill background
    context.fillRect(0, 0, canvas.width, canvas.height);

    context.fillStyle = (color == "black" ? "white" : "black");
	context.font = canvas.height/32 + "px courier";
	context.globalAlpha = 0.5;
	context.fillText("\u00A9 Adr\u00ef", (canvas.width-context.measureText("\u00A9 Adr\u00ef").width)/2, canvas.height-canvas.height/30);
	context.globalAlpha = 1;

	context.font = "italic " + canvas.height/12 + "px courier";
	context.fillText("Revert!", (canvas.width-context.measureText("Revert!").width)/2, (canvas.height-size*tile_radius)/3);
}

var touchedX, touchedY;
onmousedown = function(event) {
	touchedX = event.pageX - x_space;
	touchedY = event.pageY - y_space;
	sharedStart();
}
onmouseup = function(event) {
	sharedEnd();
}

ontouchstart = function(event) {
	touchedX = event.touches[0].pageX - x_space;
	touchedY = event.touches[0].pageY - y_space;
	sharedStart();
}
ontouchmove = function(event) {
	event.preventDefault();
}
ontouchend = function(event) {
	sharedEnd();
}

function sharedStart() {
	var x = Math.floor(touchedX/tile_radius);
	var y = Math.floor(touchedY/tile_radius);
	board[x][y].revert();
	board[x][y].draw();
	board[(x+size-1)%size][y].revert();
	board[(x+size-1)%size][y].draw();
	board[(x+1)%size][y].revert();
	board[(x+1)%size][y].draw();
	board[x][(y+size-1)%size].revert();
	board[x][(y+size-1)%size].draw();
	board[x][(y+1)%size].revert();
	board[x][(y+1)%size].draw();
}
function sharedEnd() {
	if (checkEnd()) {
		drawBackground("black");
		for (var i = 0; i < board.length; i++) {
	    	for (var j = 0; j < board[i].length; j++) {
				board[i][j].color = 2;
	    		board[i][j].draw();
	    	}
	    }		
		size++;
		setTimeout(startGame, 1000);
	}
}

function checkEnd() { //Checks if the board is ordered
	var result = true;
	for (var i = 0; i < board.length; i++) {
    	for (var j = 0; j < board.length; j++) {
	   		if (board[i][j].color != 1) {
	   			result = false;
	   		}
	   	}
    }
    return result;
}

</script>